---
import "../../styles/contact.css";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { t } from "../../i18n/i18n";
import { SITE, type Lang } from "../../data/site";

const { lang } = Astro.props as { lang: Lang };
---

<BaseLayout lang={lang} title={t(lang, "nav.contact")}>
  <section class="hero reveal">
    <h1 class="h1">{t(lang, "contact.title")}</h1>
    <p class="p">{t(lang, "contact.subtitle")}</p>
  </section>

  <section class="card reveal contact-card">
    <div class="contact-shell">
      <div class="contact-head">
        <h2 class="contact-kicker">{t(lang, "contact.formTitle")}</h2>
      </div>

      <form
        class="contact-form"
        name="contact"
        method="POST"
        action="/thanks/"
        netlify
        netlify-honeypot="bot-field"
        data-netlify-recaptcha="true"
      >
        <input type="hidden" name="form-name" value="contact" />
        <input type="hidden" name="lang" value={lang} />

        <!-- Honeypot: must be really hidden in HTML -->
        <p hidden>
          <label>
            Don’t fill this out:
            <input name="bot-field" />
          </label>
        </p>

        <div class="contact-grid">
          <div class="field">
            <label for="name">{t(lang, "contact.name")}</label>
            <input
              id="name"
              name="name"
              autocomplete="name"
              required
              placeholder={t(lang, "contact.name")}
            />
          </div>

          <div class="field">
            <label for="email">{t(lang, "contact.email")}</label>
            <input
              id="email"
              name="email"
              type="email"
              autocomplete="email"
              required
              placeholder="name@email.com"
            />
          </div>

          <div class="field field-full">
            <label for="message">{t(lang, "contact.message")}</label>
            <textarea
              id="message"
              name="message"
              rows="7"
              required
              placeholder={t(lang, "contact.message")}
            ></textarea>
          </div>

          <!-- Netlify reCAPTCHA -->
          <div class="field field-full">
            <div data-netlify-recaptcha="true"></div>
          </div>
        </div>

        <div class="contact-footer">
          <p class="contact-note">
            {t(lang, "contact.preferEmail")}
            <a href={`mailto:${SITE.email}`}>{SITE.email}</a>
          </p>

          <button class="btn contact-submit" type="submit">
            {t(lang, "contact.send")}
            <span aria-hidden="true">→</span>
          </button>
        </div>
      </form>
    </div>
  </section>

  <!-- Autoresponder trigger (fire-and-forget, survives redirect) -->
  <script type="module">
    document.addEventListener("submit", (e) => {
      const form = e.target;
      if (!(form instanceof HTMLFormElement)) return;
      if (form.getAttribute("name") !== "contact") return;

      const fd = new FormData(form);
      const payload = {
        email: fd.get("email"),
        name: fd.get("name"),
        lang: fd.get("lang") || "fr",
      };

      fetch("/.netlify/functions/autoresponder", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        keepalive: true,
      }).catch(() => {});
    });
  </script>
</BaseLayout>